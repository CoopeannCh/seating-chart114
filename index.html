<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>學生座位編排器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .group-table { border: 2px solid #cbd5e1; border-radius: .5rem; padding: .5rem; margin: .5rem; display: inline-block; }
    .group-table td { border: none !important; }
    .seat { width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; text-align: center; border-radius: .5rem; box-shadow: 0 4px 6px rgba(0,0,0,.1); transition: transform .2s; }
    .seat:hover { transform: scale(1.05); }
  </style>
  <!-- 若要啟用雲端儲存，請在這行之前引入 ./config.js -->
  <!-- <script src="./config.js"></script> -->
</head>
<body class="bg-gray-100 p-8 flex flex-col items-center min-h-screen">
  <div class="bg-white rounded-xl shadow-lg p-6 max-w-4xl w-full">
    <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">學生座位編排器</h1>

    <div class="grid md:grid-cols-2 gap-8 mb-8">
      <div class="flex flex-col space-y-4">
        <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
          <label for="students-data" class="block text-lg font-semibold text-gray-700 mb-2">學生名單與身高 (一行一位, 姓名:身高)</label>
          <textarea id="students-data" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200" placeholder="例如:&#10;A: 155&#10;B: 160&#10;C: 175&#10;..."></textarea>
          <div class="flex items-center mt-2">
            <input type="checkbox" id="height-constraint-enabled" class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
            <label for="height-constraint-enabled" class="ml-2 text-sm font-medium text-gray-700">啟用身高限制 (高個子不能坐在矮個子前面)</label>
          </div>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
          <label for="layout-type" class="block text-lg font-semibold text-gray-700 mb-2">座位排列方式:</label>
          <select id="layout-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
            <option value="single_row">一直排座位</option>
            <option value="group">小組式座位</option>
          </select>

          <div id="layout-inputs" class="mt-4">
            <div id="single-row-layout">
              <label class="block text-lg font-semibold text-gray-700 mb-2">教室大小:</label>
              <div class="flex space-x-4">
                <div class="flex-1">
                  <label for="rows" class="block text-sm font-medium text-gray-600">排數</label>
                  <input type="number" id="rows" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="5" min="1">
                </div>
                <div class="flex-1">
                  <label for="cols" class="block text-sm font-medium text-gray-600">列數</label>
                  <input type="number" id="cols" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="6" min="1">
                </div>
              </div>
            </div>
            <div id="group-layout" class="hidden">
              <label class="block text-lg font-semibold text-gray-700 mb-2">小組數量:</label>
              <div class="flex space-x-4">
                <div class="flex-1">
                  <label for="num-groups" class="block text-sm font-medium text-gray-600">組數</label>
                  <input type="number" id="num-groups" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="5" min="1">
                </div>
                <div class="flex-1">
                  <label for="group-size" class="block text-sm font-medium text-gray-600">每組座位數</label>
                  <input type="number" id="group-size" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="4" min="1">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-gray-50 p-4 rounded-lg shadow-inner flex flex-col space-y-4">
        <h2 class="text-lg font-semibold text-gray-700">限制條件:</h2>

        <div>
          <label for="not-adjacent" class="block text-sm font-medium text-gray-600">不相鄰 (例如: A,B)</label>
          <input type="text" id="not-adjacent" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="輸入學生姓名，用逗號分隔">
          <button id="add-not-adjacent" class="mt-2 w-full bg-blue-500 text-white py-1.5 rounded-lg hover:bg-blue-600 transition duration-200">新增</button>
        </div>

        <div id="preferred-rows-container">
          <label for="preferred-rows-student" class="block text-sm font-medium text-gray-600">指定排數 (例如: C, 1-2排)</label>
          <div class="flex items-center space-x-2 mt-1">
            <input type="text" id="preferred-rows-student" class="w-1/3 p-2 border border-gray-300 rounded-lg" placeholder="學生">
            <input type="text" id="preferred-rows-range" class="flex-1 p-2 border border-gray-300 rounded-lg" placeholder="排數範圍 (例如: 1-2 或 4-5)">
            <button id="add-preferred-rows" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200">新增</button>
          </div>
        </div>

        <!-- 指定列數（single_row 使用） -->
        <div id="preferred-cols-container">
          <label for="preferred-cols-student" class="block text-sm font-medium text-gray-600">指定列數 (例如: D, 2-4列)</label>
          <div class="flex items-center space-x-2 mt-1">
            <input type="text" id="preferred-cols-student" class="w-1/3 p-2 border border-gray-300 rounded-lg" placeholder="學生">
            <input type="text" id="preferred-cols-range" class="flex-1 p-2 border border-gray-300 rounded-lg" placeholder="列數範圍 (例如: 2-4)">
            <button id="add-preferred-cols" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200">新增</button>
          </div>
        </div>

        <div id="different-groups-container" class="hidden">
          <label for="different-groups" class="block text-sm font-medium text-gray-600">不同組 (例如: A,B,C)</label>
          <input type="text" id="different-groups" class="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="輸入多位學生姓名，用逗號分隔">
          <button id="add-different-groups" class="mt-2 w-full bg-blue-500 text-white py-1.5 rounded-lg hover:bg-blue-600 transition duration-200">新增</button>
        </div>
      </div>
    </div>

    <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-inner">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">已設定的限制:</h2>
      <ul id="constraints-list" class="list-disc list-inside space-y-2 text-gray-700"></ul>
    </div>

    <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-inner w-full">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">儲存與載入</h2>
      <div class="flex items-center space-x-2">
        <input type="text" id="plan-name" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="輸入座位表名稱">
        <button id="save-plan" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition duration-200">儲存</button>
        <button id="load-plan" class="bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition duration-200">載入</button>
      </div>
    </div>

    <button id="generate-plan" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-green-600 transition duration-200 shadow-md">
      生成座位表
    </button>

    <!-- 時間上限 & 停止 -->
    <div class="mt-2 flex items-center justify-end gap-2">
      <label for="time-limit" class="text-sm text-gray-500">時間上限(秒)</label>
      <input type="number" id="time-limit" value="3" min="1" max="60"
            class="w-20 p-1 border border-gray-300 rounded">
      <button id="cancel-solve"
              class="hidden bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
        停止
      </button>
    </div>

    <div id="status-message" class="mt-4 text-center font-semibold"></div>

    <div id="seating-plan-container" class="mt-8 overflow-x-auto">
      <div id="seating-plan" class="inline-block min-w-full"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', () => {
      function setStatusMessage(message, type = 'info') {
        const statusMessage = document.getElementById('status-message');
        statusMessage.textContent = message;
        if (type === 'success') statusMessage.className = 'mt-4 text-center font-semibold text-green-500';
        else if (type === 'error') statusMessage.className = 'mt-4 text-center font-semibold text-red-500';
        else statusMessage.className = 'mt-4 text-center font-semibold text-gray-700';
      }

      // ---- Firebase（選配，無設定則自動改用 localStorage） ----
      const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
      const firebaseConfig = (() => { try { return typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {}; } catch { return {}; }})();
      const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

      let app=null, db=null, auth=null, firebaseReady=false, userId='anonymous';
      const hasValidFirebaseConfig = cfg => cfg && typeof cfg === 'object' && !!cfg.apiKey;

      (async () => {
        try {
          if (hasValidFirebaseConfig(firebaseConfig)) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
            else await signInAnonymously(auth);
            userId = auth.currentUser?.uid || 'anonymous';
            firebaseReady = true;
            console.log('Firebase initialized. userId=', userId);
          } else {
            console.warn('No valid Firebase config. Save/Load will use localStorage.');
          }
        } catch (e) {
          console.warn('Firebase init/auth failed. Falling back to localStorage.', e);
          firebaseReady = false;
        }
      })();

      // ---- 狀態 ----
      let constraints = [];
      let studentsWithHeightMap = {};
      let currentSeatingPlan = {};
      let solverWorker = null;
      let solving = false;

      // ---- 渲染限制清單（含刪除鈕）----
      function renderConstraintsList() {
        const list = document.getElementById('constraints-list');
        list.innerHTML = '';
        constraints.forEach((cons, idx) => {
          const li = document.createElement('li');
          li.className = 'flex items-center justify-between bg-gray-50 rounded px-3 py-2';
          const textSpan = document.createElement('span');
          textSpan.textContent = cons.text;
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn-delete-constraint bg-red-500 hover:bg-red-600 text-white text-sm px-2 py-1 rounded';
          btn.dataset.index = String(idx);
          btn.textContent = '刪除';
          li.appendChild(textSpan);
          li.appendChild(btn);
          list.appendChild(li);
        });
        if (constraints.length === 0) {
          const li = document.createElement('li');
          li.className = 'text-gray-400';
          li.textContent = '（尚未新增限制）';
          list.appendChild(li);
        }
      }

      // ---- 解析學生資料（支援半形: / 全形：）----
      function parseStudentData() {
        const lines = document.getElementById('students-data').value
          .split('\n').map(s => s.trim()).filter(Boolean);

        const studentsList = [];
        studentsWithHeightMap = {};
        lines.forEach(line => {
          const parts = line.split(/[:：]/).map(p => p.trim());
          if (parts.length === 2) {
            const name = parts[0];
            const h = parseInt(parts[1], 10);
            studentsList.push(name);
            if (!isNaN(h)) studentsWithHeightMap[name] = h;
          } else {
            studentsList.push(parts[0]);
          }
        });
        return studentsList;
      }

      // ---- 限制條件輸入 ----
      function addConstraint(type) {
        let students, text;

        if (type === 'not_adjacent') {
          students = document.getElementById('not-adjacent').value.split(',').map(s => s.trim()).filter(Boolean);
          if (students.length !== 2) return setStatusMessage('不相鄰限制需要輸入兩位學生，用逗號分隔。', 'error');
          text = `${students[0]} 和 ${students[1]} 不能坐在一起`;
        } else if (type === 'preferred_rows') {
          const student = document.getElementById('preferred-rows-student').value.trim();
          const range = document.getElementById('preferred-rows-range').value.trim().split('-').map(Number);
          if (!student || range.length !== 2 || isNaN(range[0]) || isNaN(range[1])) return setStatusMessage('指定排數限制需要學生姓名和有效的排數範圍 (例如: 1-2)。', 'error');
          students = [student, `${range[0]}-${range[1]}`];
          text = `${student} 需要坐在第 ${range[0]} 到 ${range[1]} 排`;
        } else if (type === 'preferred_cols') {
          const student = document.getElementById('preferred-cols-student').value.trim();
          const range = document.getElementById('preferred-cols-range').value.trim().split('-').map(Number);
          if (!student || range.length !== 2 || isNaN(range[0]) || isNaN(range[1])) return setStatusMessage('指定列數限制需要學生姓名和有效的列數範圍 (例如: 2-4)。', 'error');
          students = [student, `${range[0]}-${range[1]}`];
          text = `${student} 需要坐在第 ${range[0]} 到 ${range[1]} 列`;
        } else if (type === 'different_groups') {
          students = document.getElementById('different-groups').value.split(',').map(s => s.trim()).filter(Boolean);
          if (students.length < 2) return setStatusMessage('不同組限制需要輸入至少兩位學生，用逗號分隔。', 'error');
          text = `${students.join(', ')} 需要被分到不同組`;
        } else {
          return;
        }

        constraints.push({ type, students, text });

        // 清空欄位
        document.getElementById('not-adjacent').value = '';
        document.getElementById('preferred-rows-student').value = '';
        document.getElementById('preferred-rows-range').value = '';
        const pcs = document.getElementById('preferred-cols-student'); if (pcs) pcs.value = '';
        const pcr = document.getElementById('preferred-cols-range');   if (pcr) pcr.value = '';
        document.getElementById('different-groups').value = '';

        setStatusMessage('限制已新增。', 'info');
        renderConstraintsList();
      }

      // ---- 顯示（single_row：黑板 + 最右側走廊；不做重排）----
      function displaySeatingPlan(classroomData, numRowsOrGroups, numColsOrGroupSize, layoutType) {
        const container = document.getElementById('seating-plan');
        container.innerHTML = '';
        if (!classroomData) return;

        if (layoutType === 'single_row') {
          const table = document.createElement('table');
          table.className = 'border-collapse w-full rounded-lg overflow-hidden shadow-lg';

          // 黑板列（右邊多一欄是走廊，因此 colSpan + 1）
          const boardRow = document.createElement('tr');
          const boardCell = document.createElement('td');
          boardCell.colSpan = numColsOrGroupSize + 1;
          boardCell.className = 'bg-black text-white text-center font-bold py-2';
          boardCell.textContent = '黑板';
          boardRow.appendChild(boardCell);
          table.appendChild(boardRow);

          // 每排：座位 + 走廊
          for (let r = 0; r < numRowsOrGroups; r++) {
            const tr = document.createElement('tr');
            for (let c = 0; c < numColsOrGroupSize; c++) {
              const td = document.createElement('td');
              td.className = 'border border-gray-300 p-4 text-center h-24 w-24 md:h-28 md:w-28 bg-gray-50';
              const name = classroomData[r][c];
              if (name) {
                td.textContent = name;
                td.className += ' bg-blue-200 text-blue-800 font-bold text-xl rounded-lg shadow-md transition transform hover:scale-105';
              } else {
                td.textContent = '空位';
                td.className += ' text-gray-400 text-xl';
              }
              tr.appendChild(td);
            }

            // 最右邊走廊（純顯示，不參與求解）
            const corridor = document.createElement('td');
            corridor.className = corridor.className = 'border border-gray-300 p-4 text-center h-24 md:h-28 w-16 md:w-20 bg-gray-800 text-white font-bold';
            corridor.textContent = '走廊';
            tr.appendChild(corridor);

            table.appendChild(tr);
          }
          container.appendChild(table);

        } else if (layoutType === 'group') {
          const gridDiv = document.createElement('div');
          gridDiv.className = 'flex flex-wrap justify-center';

          classroomData.forEach((group, index) => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group-table bg-white shadow-xl rounded-xl';

            const title = document.createElement('h3');
            title.className = 'text-center text-xl font-bold mb-2 text-gray-800';
            title.textContent = `第 ${index + 1} 組`;
            groupDiv.appendChild(title);

            const table = document.createElement('table');
            table.className = 'border-collapse';
            let row = document.createElement('tr');

            const totalSeats = numColsOrGroupSize;
            for (let i = 0; i < totalSeats; i++) {
              const td = document.createElement('td');
              td.className = 'p-2';
              const seatDiv = document.createElement('div');
              if (i < group.length) {
                seatDiv.textContent = group[i];
                seatDiv.className = 'seat bg-blue-200 text-blue-800 font-bold text-xl rounded-lg shadow-md transition transform hover:scale-105';
              } else {
                seatDiv.textContent = '空位';
                seatDiv.className = 'seat bg-gray-50 text-gray-400 text-xl';
              }
              td.appendChild(seatDiv);
              row.appendChild(td);
            }

            table.appendChild(row);
            groupDiv.appendChild(table);
            gridDiv.appendChild(groupDiv);
          });

          container.appendChild(gridDiv);
        }
      }

      // ---- 啟動 Worker 進行求解（single_row 用）----
      async function generateSeatingPlan() {
        if (solving) return;

        const students = parseStudentData();
        const layoutType = document.getElementById('layout-type').value;

        let numRows, numCols, numGroups, groupSize;

        if (layoutType === 'single_row') {
          numRows = parseInt(document.getElementById('rows').value, 10);
          numCols = parseInt(document.getElementById('cols').value, 10);
          if (isNaN(numRows) || isNaN(numCols) || numRows <= 0 || numCols <= 0) {
            setStatusMessage('請輸入有效的排數/列數。', 'error');
            return;
          }
          if (students.length > numRows * numCols) {
            setStatusMessage(`座位不足！學生人數(${students.length})超過座位總數(${numRows * numCols})。`, 'error');
            return;
          }

          const timeLimitSec = Math.max(1, Math.min(60, parseInt(document.getElementById('time-limit').value, 10) || 3));
          const heightOn = document.getElementById('height-constraint-enabled').checked;

          // 建立 worker（用 import.meta.url 避免 GitHub Pages 子路徑問題）
          let workerUrl;
          try {
            workerUrl = new URL(`./solver.worker.js?v=${Date.now()}`, import.meta.url);
            solverWorker = new Worker(workerUrl, { type: 'module' });
          } catch (e) {
            console.error(e);
            setStatusMessage('無法啟動計算工作執行緒。請確認 solver.worker.js 與本頁同目錄。', 'error');
            return;
          }

          // UI 狀態
          const cancelBtn = document.getElementById('cancel-solve');
          const genBtn = document.getElementById('generate-plan');
          solving = true;
          genBtn.disabled = true;
          cancelBtn.classList.remove('hidden');
          setStatusMessage(`搜尋中（上限 ${timeLimitSec} 秒）…`, 'info');

          // 接 worker 訊息
          solverWorker.onmessage = (ev) => {
            const { type, payload } = ev.data || {};
            if (type === 'progress') {
              const { placed, total } = payload;
              setStatusMessage(`搜尋中… ${placed}/${total}`, 'info');
              return;
            }
            if (type === 'result') {
              // 收尾
              try { solverWorker.terminate(); } catch {}
              solverWorker = null;
              solving = false;
              genBtn.disabled = false;
              cancelBtn.classList.add('hidden');

              if (payload.ok) {
                const { plan, numRows, numCols } = payload;
                currentSeatingPlan = { students, plan, layout: 'single_row', numRows, numCols };
                setStatusMessage('座位表成功生成！', 'success');
                displaySeatingPlan(plan, numRows, numCols, 'single_row');
              } else {
                setStatusMessage(payload.message || '失敗', 'error');
                displaySeatingPlan(null, numRows, numCols, 'single_row');
              }
            }
          };

          solverWorker.onerror = (err) => {
            console.error(err);
            setStatusMessage('計算執行緒發生錯誤。', 'error');
            try { solverWorker.terminate(); } catch {}
            solverWorker = null;
            solving = false;
            document.getElementById('generate-plan').disabled = false;
            document.getElementById('cancel-solve').classList.add('hidden');
          };

          // 開始求解（符合 worker 期望的格式）
          solverWorker.postMessage({
            type: 'start',
            payload: {
              students,
              studentsWithHeightMap,
              constraints,
              numRows,
              numCols,
              timeLimitSec,
              heightConstraintEnabled: heightOn
            }
          });

          return;
        }

        // ===== group（維持同步算法）=====
        numGroups = parseInt(document.getElementById('num-groups').value, 10);
        groupSize = parseInt(document.getElementById('group-size').value, 10);
        if (isNaN(numGroups) || isNaN(groupSize) || numGroups <= 0 || groupSize <= 0) {
          setStatusMessage('請輸入有效的組數/每組座位數。', 'error');
          return;
        }
        if (students.length > numGroups * groupSize) {
          setStatusMessage(`座位不足！學生人數(${students.length})超過座位總數(${numGroups * groupSize})。`, 'error');
          return;
        }
        const planData = Array.from({ length: numGroups }, () => []);
        const shuffled = [...students].sort(() => Math.random() - 0.5);

        const solve = (idx) => {
          if (idx === shuffled.length) return true;
          const s = shuffled[idx];
          const order = Array.from({ length: numGroups }, (_, i) => i).sort((a, b) => planData[a].length - planData[b].length);
          for (const g of order) {
            if (planData[g].length < groupSize && isPlacementValid(s, g, null, planData, 'group')) {
              planData[g].push(s);
              if (solve(idx + 1)) return true;
              planData[g].pop();
            }
          }
          return false;
        };

        if (solve(0)) {
          currentSeatingPlan = { students, plan: planData, layout: 'group', numGroups, groupSize };
          setStatusMessage('座位表成功生成！', 'success');
          displaySeatingPlan(planData, numGroups, groupSize, 'group');
        } else {
          setStatusMessage('無法在限制條件下找到合適的座位安排。請調整限制或增加座位數。', 'error');
          displaySeatingPlan(null, numGroups, groupSize, 'group');
        }
      }

      // ---- 檢查限制（只有 group 用得到；single_row 由 worker 處理）----
      function isPlacementValid(student, r, c, grid, layoutType) {
        if (layoutType === 'group') {
          const curGroup = grid[r];
          const notAdj = constraints.find(cons =>
            cons.type === 'not_adjacent' &&
            ((cons.students[0] === student && curGroup.includes(cons.students[1])) ||
             (cons.students[1] === student && curGroup.includes(cons.students[0])))
          );
          if (notAdj) return false;

          const diff = constraints.find(cons => cons.type === 'different_groups');
          if (diff && diff.students.includes(student)) {
            for (const ps of curGroup) if (diff.students.includes(ps)) return false;
          }
        }
        return true;
      }

      function findStudentPos(studentName, grid, layoutType) {
        if (layoutType === 'group') {
          for (let r = 0; r < grid.length; r++) {
            if (grid[r].includes(studentName)) return { r, c: null };
          }
        }
        return null;
      }

      // ---- 儲存 / 載入（Firebase 或 localStorage）----
      async function savePlan() {
        const planName = document.getElementById('plan-name').value.trim();
        if (!planName) return setStatusMessage('請輸入座位表名稱。', 'error');

        const studentsData = document.getElementById('students-data').value;
        const layoutType = document.getElementById('layout-type').value;
        const heightConstraintEnabled = document.getElementById('height-constraint-enabled').checked;
        const layoutSettings = (layoutType === 'single_row')
          ? { rows: parseInt(document.getElementById('rows').value, 10), cols: parseInt(document.getElementById('cols').value, 10) }
          : { numGroups: parseInt(document.getElementById('num-groups').value, 10), groupSize: parseInt(document.getElementById('group-size').value, 10) };

        const dataToSave = {
          studentsData,
          constraints: JSON.stringify(constraints),
          layoutType,
          layoutSettings,
          heightConstraintEnabled
        };

        try {
          if (firebaseReady && db) {
            const ref = doc(db, 'artifacts', appId, 'users', userId, 'seating_plans', planName);
            await setDoc(ref, dataToSave);
            setStatusMessage(`座位表 "${planName}" 已成功儲存（雲端）！`, 'success');
          } else {
            localStorage.setItem(`seating_plan_${planName}`, JSON.stringify(dataToSave));
            setStatusMessage(`座位表 "${planName}" 已成功儲存（本機）！`, 'success');
          }
        } catch (e) {
          console.error(e);
          setStatusMessage(`儲存失敗: ${e.message}`, 'error');
        }
      }

      async function loadPlan() {
        const planName = document.getElementById('plan-name').value.trim();
        if (!planName) return setStatusMessage('請輸入要載入的座位表名稱。', 'error');

        try {
          let data = null;
          if (firebaseReady && db) {
            const ref = doc(db, 'artifacts', appId, 'users', userId, 'seating_plans', planName);
            const snap = await getDoc(ref);
            if (snap.exists()) data = snap.data();
          } else {
            const raw = localStorage.getItem(`seating_plan_${planName}`);
            if (raw) data = JSON.parse(raw);
          }

          if (!data) return setStatusMessage(`找不到名稱為 "${planName}" 的座位表。`, 'error');

          document.getElementById('students-data').value = data.studentsData || '';
          document.getElementById('layout-type').value = data.layoutType || 'single_row';
          document.getElementById('height-constraint-enabled').checked = !!data.heightConstraintEnabled;

          constraints = JSON.parse(data.constraints || '[]');
          renderConstraintsList();

          document.getElementById('layout-type').dispatchEvent(new Event('change'));
          if (data.layoutType === 'single_row') {
            document.getElementById('rows').value = data.layoutSettings?.rows ?? 5;
            document.getElementById('cols').value = data.layoutSettings?.cols ?? 6;
          } else {
            document.getElementById('num-groups').value = data.layoutSettings?.numGroups ?? 5;
            document.getElementById('group-size').value = data.layoutSettings?.groupSize ?? 4;
          }

          setStatusMessage(`座位表 "${planName}" 已成功載入！`, 'success');
        } catch (e) {
          console.error(e);
          setStatusMessage(`載入失敗: ${e.message}`, 'error');
        }
      }

      // ---- 事件綁定 ----
      document.getElementById('generate-plan').addEventListener('click', generateSeatingPlan);
      document.getElementById('add-not-adjacent').addEventListener('click', () => addConstraint('not_adjacent'));
      document.getElementById('add-preferred-rows').addEventListener('click', () => addConstraint('preferred_rows'));
      document.getElementById('add-preferred-cols').addEventListener('click', () => addConstraint('preferred_cols'));
      document.getElementById('add-different-groups').addEventListener('click', () => addConstraint('different_groups'));
      document.getElementById('save-plan').addEventListener('click', savePlan);
      document.getElementById('load-plan').addEventListener('click', loadPlan);

      // 代理監聽刪除按鈕
      document.getElementById('constraints-list').addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-delete-constraint');
        if (!btn) return;
        const idx = parseInt(btn.dataset.index, 10);
        if (Number.isInteger(idx) && idx >= 0 && idx < constraints.length) {
          constraints.splice(idx, 1);
          renderConstraintsList();
          setStatusMessage('已刪除一個限制。', 'info');
        }
      });

      // 停止求解
      document.getElementById('cancel-solve').addEventListener('click', () => {
        if (solverWorker) {
          try { solverWorker.postMessage({ type: 'cancel' }); } catch {}
          try { solverWorker.terminate(); } catch {}
          solverWorker = null;
        }
        solving = false;
        document.getElementById('generate-plan').disabled = false;
        document.getElementById('cancel-solve').classList.add('hidden');
        setStatusMessage('已停止。', 'info');
      });

      const layoutTypeSelect = document.getElementById('layout-type');
      const singleRowLayoutDiv = document.getElementById('single-row-layout');
      const groupLayoutDiv = document.getElementById('group-layout');
      const preferredRowsContainer = document.getElementById('preferred-rows-container');
      const preferredColsContainer = document.getElementById('preferred-cols-container');
      const differentGroupsContainer = document.getElementById('different-groups-container');

      layoutTypeSelect.addEventListener('change', (e) => {
        if (e.target.value === 'single_row') {
          singleRowLayoutDiv.classList.remove('hidden');
          groupLayoutDiv.classList.add('hidden');
          preferredRowsContainer.classList.remove('hidden');
          preferredColsContainer.classList.remove('hidden');
          differentGroupsContainer.classList.add('hidden');
        } else {
          singleRowLayoutDiv.classList.add('hidden');
          groupLayoutDiv.classList.remove('hidden');
          preferredRowsContainer.classList.add('hidden');
          preferredColsContainer.classList.add('hidden');
          differentGroupsContainer.classList.remove('hidden');
        }
      });

      // 初次渲染清單（顯示空提示）
      renderConstraintsList();
    });
  </script>
</body>
</html>

